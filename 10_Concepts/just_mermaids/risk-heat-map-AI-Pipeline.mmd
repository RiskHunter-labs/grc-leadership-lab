flowchart TD
  %% simple colors for residual risk
  classDef low fill:#e9f7ef,stroke:#1e7e34,stroke-width:1px,color:#0b3d1f
  classDef med fill:#fff6e5,stroke:#ad6800,stroke-width:1px,color:#5a3200
  classDef high fill:#fdecea,stroke:#a8071a,stroke-width:1px,color:#5c0011

  %% STAGES (same content you have, shortened labels shown here—keep yours if you like)
  subgraph "Data Ingestion"
    DI["Stage: Data Ingestion"]
    R1["Risk: PII leakage; biased sources; data poisoning"]
    C1["Control: DLP; bias checks; source validation; checksums; ISO/IEC 42001 8.6.2, 8.5.3; NIST Map 1.3, Manage 2.2; EU AI Act 10(3)"]
  end
  class DI,R1, C1 med

  subgraph "Data Storage and Governance"
    DG["Stage: Storage and Governance"]
    R2["Risk: unauthorized access; missing lineage; non‑compliance"]
    C2["Control: IAM RBAC; at‑rest encryption; lineage; retention; ISO/IEC 42001 8.6.1, 8.6.3; NIST Govern 1.2, Manage 3.1; EU 15"]
  end
  class DG,R2,C2 med

  subgraph "Data Prep and Labeling"
    DP["Stage: Preparation and Labeling"]
    R3["Risk: label bias; annotation errors; sensitive exposure"]
    C3["Control: multi‑annotator QA; anonymization; consensus; sampling; ISO/IEC 42001 8.5.2, 8.5.4; NIST Map 2.1, Manage 2.3; EU 10(5)"]
  end
  class DP,R3,C3 high

  subgraph "Feature Engineering"
    FE["Stage: Feature Engineering and Store"]
    R4["Risk: feature leakage; offline/online skew"]
    C4["Control: parity tests; schema validation; secure store; ISO/IEC 42001 8.7.3; NIST Map 3.2, Manage 2.1; EU Annex IV"]
  end
  class FE,R4,C4 med

  subgraph "Model Training"
    MT["Stage: Model Training"]
    R5["Risk: poisoning; overfitting; insecure env"]
    C5["Control: enclaves; adversarial training; regularization; reproducibility; ISO/IEC 42001 8.7.1, 8.7.4; NIST Govern 2.3, Manage 3.2; EU 15(2)"]
  end
  class MT,R5,C5 high

  subgraph "Evaluation and Validation"
    EV["Stage: Evaluation and Validation"]
    R6["Risk: hidden bias; coverage gaps; fairness"]
    C6["Control: DP/EO metrics; stress tests; model cards; red team; ISO/IEC 42001 8.8.1, 8.8.2; NIST Map 4.1, Manage 4.3; EU 14(4)"]
  end
  class EV,R6,C6 med

  subgraph "Model Registry and CI CD"
    MR["Stage: Registry and Release"]
    R7["Risk: unapproved promotion; tampering; deps"]
    C7["Control: gates; signed artifacts; dep scan; SBOMs; ISO/IEC 42001 8.9.1, 8.9.2; NIST Govern 3.1, Manage 4.1; EU 15(3)"]
  end
  class MR,R7,C7 low

  subgraph "Deployment and Serving"
    DS["Stage: Deployment"]
    R8["Risk: prompt injection; model theft; unsafe outputs"]
    C8["Control: output filters; rate limit; watermark; access controls; ISO/IEC 42001 8.10.1, 8.10.3; NIST Manage 5.1, Map 5.2; EU 14(5)"]
  end
  class DS,R8,C8 med

  subgraph "Monitoring and Feedback"
    MF["Stage: Monitoring and Feedback"]
    R9["Risk: concept drift; perf degradation; harmful outputs unseen"]
    C9["Control: drift detect; HITL review; retrain triggers; rollback; ISO/IEC 42001 8.11.1, 8.11.2; NIST Govern 4.2, Manage 5.3; EU 61(1)"]
  end
  class MF,R9,C9 high

  DI --> DG --> DP --> FE --> MT --> EV --> MR --> DS --> MF
